(function() {
    const sharedBy = ghRating.sharedBy;

    if (sharedBy === 'www.giahuy.net') {
        const ratingWrap = document.querySelector('.rating-wrap');
        const stars = document.querySelectorAll('.stars-svg');
        const resultRating = document.querySelector('.result-rating');
        const alreadyRt = document.querySelector('.alreadyRt');
        const ratingBox = document.querySelector('.rating-box');
        const postPath = ratingWrap.getAttribute('data-rating');

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Function to get user rating from Firebase
        function getUserRating() {
            const userId = firebase.auth().currentUser ? firebase.auth().currentUser.uid : 'guest';

            const ratingRef = database.ref(postPath + '/ratings/' + userId);
            ratingRef.once('value').then(snapshot => {
                const userRating = snapshot.val();
                if (userRating) {
                    displayUserRating(userRating);
                    alreadyRt.style.display = 'block';
                    disableRating();
                } else {
                    enableRating();
                }
            }).catch(error => {
                console.error("Error fetching user rating: ", error);
            });
        }

        // Function to display the user's rating
        function displayUserRating(rating) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            resultRating.setAttribute('aria-label', rating);
        }

        // Function to enable the rating functionality
        function enableRating() {
            stars.forEach((star, index) => {
                star.addEventListener('mouseover', () => {
                    highlightStars(index + 1);
                });
                star.addEventListener('mouseout', clearStars);
                star.addEventListener('click', () => {
                    submitRating(index + 1);
                });
            });
        }

        // Function to highlight stars on hover
        function highlightStars(rating) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('hover');
                } else {
                    star.classList.remove('hover');
                }
            });
        }

        // Function to clear star highlights
        function clearStars() {
            stars.forEach(star => {
                star.classList.remove('hover');
            });
        }

        // Function to submit the rating to Firebase
        function submitRating(rating) {
            const userId = firebase.auth().currentUser ? firebase.auth().currentUser.uid : 'guest';

            const ratingRef = database.ref(postPath + '/ratings/' + userId);
            ratingRef.set(rating).then(() => {
                displayUserRating(rating);
                alreadyRt.style.display = 'block';
                disableRating();
            }).catch(error => {
                console.error("Error submitting rating: ", error);
            });
        }

        // Function to disable the rating functionality
        function disableRating() {
            stars.forEach(star => {
                star.style.pointerEvents = 'none';
            });
        }

        // Function to calculate and display the average rating
        function displayAverageRating() {
            const ratingsRef = database.ref(postPath + '/ratings');

            ratingsRef.on('value', snapshot => {
                const ratings = snapshot.val();
                let totalRating = 0;
                let ratingCount = 0;

                for (let userId in ratings) {
                    totalRating += ratings[userId];
                    ratingCount++;
                }

                const averageRating = ratingCount ? (totalRating / ratingCount).toFixed(1) : 0;
                resultRating.setAttribute('aria-label', averageRating);
            });
        }

        // Event listener for authentication state changes
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                getUserRating();
                displayAverageRating();
            } else {
                // Optionally handle unauthenticated users
                console.warn("User not authenticated");
                // Redirect or show login modal if needed
                // location.href = '/login'; // Example redirect
            }
        });
    } else {
        window.location.href = 'https://www.giahuy.net/p/credit.html';
    }
})();
